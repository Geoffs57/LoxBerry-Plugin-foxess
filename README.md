# LoxBerry-Plugin-foxess


This Loxberry Plugin obtains and formats the power values from the associated FoxESS Cloud API and sends them to the miniserver via a udp message. The Grid power value is negative when power is being exported to the grid, and positive when power from the grid is consumed. The Battery Power value is negative when the battery is being charged and positive when the battery is being discharged.  The Solar Power value is always positive, as is the House Load Power value.  These values are then ready to use with the Loxone Energy Flow Monitor and/or Energy Manager components.
The script makes one complex call to the API to obtain all the power and battery values it needs, but because of additional calls made by the foxesscloud library itself to authenticate this decrements the available API calls by 4 each time the script is run.
On the standard FoxESS user tier you are only allowed 1440 calls per day, so the plugin executes the script once every 5 minutes to avoid exceeding that limit.  If you edit the plugin it to run more frequently, say every 1 minute, it will exhaust the number of available API calls before the end of the day.  The logfile will then show an error every time it runs until the cloud service trips over to the next day and grants more calls.

The Plugin is supposed to work on LoxBerry > v2.2, but has only been tested on LoxBerry v3.0

Post installation on the Loxberry the plugin requires the following configuration settings to be applied

```
[FOXESS]
API_KEY = {api key for foxess account}
SERIAL = {serial number of first inverter for foxess account}

[MINISERVER]
IPADDRESS = {miniserver IPv4 address}
PORT = {udp port to push data to miniserver}
```

## Data sent via JSON to miniserver
The following is an example of a json struct sent to the miniserver, containing the following data:
* 1. Current date
* 2. Current time
* 3. Power being consumed by the house
* 4. Power going to/from the Grid connection
* 5. Power being generated by the Solar Panels
* 6. Power being sent to/from the Battery
* 7. Current Battery State of Charge (SoC)


        msg = {
            'dat':currentdate,
            'tim':currenttime,
            'con':ldpwr,
            'grd':grdpwr,
            'gen':pvpwr,
            'bat':batpwr,
            'soc':btsoc
             }

## Miniserver Configuration requirements (Loxone Config) 

Using the plugin also requires the miniserver configuration to be set up to receive the values being sent.  Do this as follows:

First create a Virtual UDP Input and then add a series of Virtual UDP input commands to receive each of the five values as shown below:

Virtual Input settings

![Alt text](ReadmeImages/Virtual%20Input%20List.png)

Virtual Input Command Settings

![Alt text](ReadmeImages/Virtual%20Input%20Command%20Detail.png)

Test using UDP Monitor to verify that the miniserver receives the message and extracts the values correctly.

Then add Meter Function blocks with the values from the UDP inputs connected to the relevant meter inputs as follows:

![Alt text](ReadmeImages/Energy%20Monitor%20and%20Meter%20Config.png?raw=true)

For the Grid connection use a bidirectional meter block, for the battery use a storage meter block, and for the solar panels and house load use ordinary meter blocks.  In each case name the block appropriately and set the icon to a suitable value.  For the Grid and Battery blocks also make sure the power direction setting matches the signed values as returned by this plugin.

Lastly add the Energy Flow Monitor Function Block and configure it as follows

![Alt text](ReadmeImages/Energy%20Flow%20Monitor%20Config.png)

Confirm that the Grid is set as type Grid, the Solar is set as Type Producer, and the House Load is set as Type Consumer.

## Further Information


Plugin information and documentation page can be found at:
https://wiki.loxberry.de/plugins/foxess_bridge/start


<!-- LICENSE -->
## License

Distributed under the Apache License 2.0. See `LICENSE` for more information.

<!-- CONTACT -->
## Contact

Geoff Sullivan 

Project Link: [https://github.com/Geoffs57/LoxBerry-Plugin-foxess](https://github.com/Geoffs57/LoxBerry-Plugin-foxess)

<!-- ACKNOWLEDGMENTS -->
## Acknowledgments

This complete plugin framework has been cloned from Loxberry-Plugin-myenergi by Christoph Moar, thanks for the template.
The plugin itself relies on the Python Project Library for accessing FoxESS Cloud, and its usage would not be possible without these fine projects:

* [Python Project FoxESS Cloud Library](https://pypi.org/project/foxesscloud/)
* [LoxBerry-Plugin-myenergi](https://github.com/christophmoar/LoxBerry-Plugin-myenergi)
* [LoxBerry-Plugin-solaredge](https://github.com/ingenarius/LoxBerry-Plugin-solaredge)
* [Loxberry](https://wiki.loxberry.de)
* [Loxforum](https://www.loxforum.com)
